# Деплой и оптимизация под ограниченный CPU/RAM

Рекомендации для продакшена (в т.ч. при гарантии 10% CPU и 4 ГБ RAM).

## 1. Режим production

- **Запуск:** всегда `next build` и затем `next start`.
- Не использовать `next dev` на сервере.
- Убедиться, что `NODE_ENV=production` (при `next start` выставляется автоматически).

## 2. Сборка и старт

```bash
npm ci
npm run build
npm run start
```

## 3. Кэширование и статика (уже сделано в проекте)

- Страницы используют **ISR**: `revalidate = 60` (секунды).
- GET-запросы к Directus кэшируются через `next.revalidate` в `lib/directus/client.ts`.
- Для коллекций и товаров включён **generateStaticParams** — страницы пререндерятся при сборке и доревалидируются по таймеру.

## 4. Оптимизация изображений

- Установлен **sharp** — Next.js использует его для оптимизации картинок через `next/image`.
- Локальные и разрешённые remote-хосты обрабатываются пайплайном Next.js; при нехватке CPU можно оставить `unoptimized` для части изображений (как сейчас для удалённых в карточках).

## 5. Анализ бандла

Чтобы проверить размер сборки:

```bash
npm run analyze
```

Откроется отчёт в `.next/analyze/` (client/nodejs/edge).

## 6. Что проверить на сервере (вручную)

- `htop` / `top` — загрузка CPU процессами Node (Next.js, Directus).
- `free -h` — использование RAM и swap.
- Запуск через `next start`, не `next dev`.
- При использовании Directus: по возможности PostgreSQL/MySQL вместо SQLite и кэш (например, Redis) по документации Directus.

## 7. Переменные окружения для сборки

Для статической генерации страниц каталога при `next build` желательно задать:

- `CATALOG_SOURCE=directus`
- `DIRECTUS_URL=...`

Тогда `generateStaticParams` подтянет реальные slug коллекций и товаров из Directus и соберёт страницы заранее.
